USE GRAPH ldbc_snb
DROP QUERY ic_7

CREATE QUERY ic_7(vertex<Person> personId) FOR GRAPH ldbc_snb {
  TYPEDEF tuple(int personId, 
                string personFirstName, 
                string personLastName, 
                datetime likeCreationDate, 
                int commentOrPostId,
                string commentOrPostContent,
                int minutesLatency,
                bool isNew) likerInfo;

  SumAccum<int> @likeCreationDate;
  SumAccum<int> @commentOrPostId;
  SumAccum<string> @commentOrPostContent;
  SumAccum<int> @minutesLatency;
  AndAccum @isNew;
  HeapAccum<likerInfo>(20, likeCreationDate DESC, personId ASC) @@likerInfoTop;

  vPerson = { personId };
	
  vFriend = 
    SELECT t
    FROM vPerson:s-((<Comment_HAS_CREATOR_Person|<Post_HAS_CREATOR_Person):e1)-(Comment|Post):im1-((<Person_LIKES_Comment|<Person_LIKES_Post):e2)-Person:t
    ACCUM 
      t.@likeCreationDate = datetime_to_epoch(e2.creationDate),
      t.@commentOrPostId = im1.id,
      CASE
        WHEN im1.type == "Comment" THEN
          t.@commentOrPostContent = im1.content
        ELSE
          t.@commentOrPostContent = im1.imageFile
      END,
      t.@minutesLatency = (datetime_diff(im1.creationDate, e2.creationDate) / 60),

  vFriend = 
    SELECT s
    FROM vFriend:s-(Person_KNOWS_Person>:e)-Person:t
    ACCUM CASE WHEN t == personId THEN s.@isNew += False END
    POST-ACCUM @@likerInfoTop += likerInfo(s.id, 
                                           s.firstName, 
                                           s.lastName, 
                                           epoch_to_datetime(s.@likeCreationDate), 
                                           s.@commentOrPostId, 
                                           s.@commentOrPostContent, 
                                           s.@minutesLatency, 
                                           s.@isNew);

  PRINT @@likerInfoTop;
}

INSTALL QUERY ic_7